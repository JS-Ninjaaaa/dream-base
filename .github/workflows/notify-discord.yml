name: Notify Discord on PR Assign/Review

on:
  pull_request:
    types: [assigned, review_requested]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Write user_map.json from Secret

        run: echo '${{ secrets.DISCORD_USER_MAP_JSON }}' > user_map.json

      - name: Read user_map and notify Discord
        env:
          DISCORD_PR_WEBHOOK: ${{ secrets.DISCORD_PR_WEBHOOK }}
          EVENT_TYPE: ${{ github.event.action }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # ASSIGNEE / REVIEWER ã‚’ null-safe ã«å–å¾—
          ASSIGNEE="${{ github.event.pull_request.assignee && github.event.pull_request.assignee.login || '' }}"
          REVIEWER="${{ github.event.requested_reviewer && github.event.requested_reviewer.login || '' }}"

          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
          USER=""
          MENTION="@here"
          ACTION=""

          # ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«ã‚ˆã£ã¦å‡¦ç†åˆ†å²
          if [ "$EVENT_TYPE" = "assigned" ]; then
            USER="$ASSIGNEE"
            ACTION="âœ…ã‚¢ã‚µã‚¤ãƒ³ã•ã‚Œã¾ã—ãŸ"
          elif [ "$EVENT_TYPE" = "review_requested" ]; then
            USER="$REVIEWER"
            ACTION="ğŸ‘€ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚Œã¾ã—ãŸ"
          fi

          # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°èª­ã¿è¾¼ã¿, secretã‹ã‚‰
          DISCORD_ID=$(jq -r --arg user "$USER" '.[$user]' user_map.json)

          if [ "$DISCORD_ID" != "null" ] && [ -n "$DISCORD_ID" ]; then
            MENTION="<@$DISCORD_ID>"
          fi

          # Discordé€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
          cat <<EOF > message.json
          {
            "content": "$MENTION PullRequestãŒ$ACTION: [$PR_TITLE]($PR_URL)"
          }
          EOF

          # Discordã«é€ä¿¡
          curl -H "Content-Type: application/json" -X POST -d @message.json "$DISCORD_PR_WEBHOOK"
